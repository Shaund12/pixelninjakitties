<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Ninja Kitties - Admin Dashboard</title>
    <link rel="icon" href="../assets/detailed_ninja_cat_64.png">
    <style>
        :root {
            --primary: #8a65ff;
            --secondary: #2775ca;
            --accent: #4FD1C5;
            --background: #121212;
            --background-light: #23263a;
            --card-bg: #1e1e1e;
            --text: #e0e0e0;
            --text-light: #b0b0b0;
            --border: #333;
            --success: #4CAF50;
            --warning: #ff9800;
            --error: #f44336;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .header h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .stat-card h3 {
            color: var(--accent);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .section {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .section h2 {
            color: var(--accent);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .table th {
            background: var(--background-light);
            color: var(--accent);
            font-weight: 600;
        }

        .table tr:hover {
            background: var(--background-light);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge.success {
            background: var(--success);
            color: white;
        }

        .badge.warning {
            background: var(--warning);
            color: white;
        }

        .badge.error {
            background: var(--error);
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-light);
        }

        .error {
            background: var(--error);
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .timeframe-selector {
            margin-bottom: 20px;
        }

        .timeframe-selector select {
            background: var(--background-light);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .refresh-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
        }

        .refresh-btn:hover {
            background: var(--primary-dark);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü•∑ Pixel Ninja Kitties Admin Dashboard</h1>
            <p>Real-time marketplace analytics and user insights</p>
        </div>

        <div class="timeframe-selector">
            <label for="timeframe">Timeframe:</label>
            <select id="timeframe">
                <option value="24h">Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
            </select>
            <button class="refresh-btn" onclick="refreshData()">Refresh Data</button>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Active Users</h3>
                <div class="stat-value" id="activeUsers">-</div>
                <div class="stat-label">Recent Activity</div>
            </div>
            <div class="stat-card">
                <h3>Total Views</h3>
                <div class="stat-value" id="totalViews">-</div>
                <div class="stat-label">NFT Page Views</div>
            </div>
            <div class="stat-card">
                <h3>New Listings</h3>
                <div class="stat-value" id="newListings">-</div>
                <div class="stat-label">Created Recently</div>
            </div>
            <div class="stat-card">
                <h3>Sales</h3>
                <div class="stat-value" id="totalSales">-</div>
                <div class="stat-label">Completed Transactions</div>
            </div>
        </div>

        <div class="section">
            <h2>Top Viewed NFTs</h2>
            <div id="topViewedLoading" class="loading">Loading...</div>
            <div id="topViewedError" class="error" style="display: none;"></div>
            <div id="topViewedContent" style="display: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Token ID</th>
                            <th>Views</th>
                            <th>Last Activity</th>
                        </tr>
                    </thead>
                    <tbody id="topViewedTable">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>Floor Prices by Rarity</h2>
            <div id="floorPricesLoading" class="loading">Loading...</div>
            <div id="floorPricesError" class="error" style="display: none;"></div>
            <div id="floorPricesContent" style="display: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Rarity</th>
                            <th>Floor Price</th>
                            <th>Currency</th>
                            <th>Sample Size</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="floorPricesTable">
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>Recent Activity</h2>
            <div id="recentActivityLoading" class="loading">Loading...</div>
            <div id="recentActivityError" class="error" style="display: none;"></div>
            <div id="recentActivityContent" style="display: none;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Event</th>
                            <th>Token ID</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="recentActivityTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        import { getMarketplaceAnalytics, getFloorStats, getTrendingTokens } from '../js/supabaseClient.js';
        import { initializeSupabase } from '../js/supabase.js';

        let supabase;

        async function initializeApp() {
            try {
                supabase = await initializeSupabase();
                console.log('‚úÖ Admin dashboard initialized with Supabase');
                await loadDashboardData();
            } catch (error) {
                console.error('‚ùå Failed to initialize admin dashboard:', error);
                showError('Failed to initialize dashboard. Please check your Supabase configuration.');
            }
        }

        async function loadDashboardData() {
            const timeframe = document.getElementById('timeframe').value;
            
            try {
                // Load analytics data
                const analytics = await getMarketplaceAnalytics(timeframe);
                updateStatsCards(analytics);
                
                // Load floor prices
                await loadFloorPrices();
                
                // Load trending tokens
                await loadTrendingTokens();
                
                // Load recent activity
                await loadRecentActivity();
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showError('Failed to load dashboard data: ' + error.message);
            }
        }

        function updateStatsCards(analytics) {
            document.getElementById('activeUsers').textContent = analytics.activeUsers;
            document.getElementById('totalViews').textContent = analytics.totalViews;
            document.getElementById('newListings').textContent = analytics.newListings;
            document.getElementById('totalSales').textContent = analytics.totalSales;
        }

        async function loadFloorPrices() {
            const loading = document.getElementById('floorPricesLoading');
            const error = document.getElementById('floorPricesError');
            const content = document.getElementById('floorPricesContent');
            const table = document.getElementById('floorPricesTable');

            loading.style.display = 'block';
            error.style.display = 'none';
            content.style.display = 'none';

            try {
                const floorStats = await getFloorStats();
                
                if (floorStats.length === 0) {
                    table.innerHTML = '<tr><td colspan="5" class="no-data">No floor price data available</td></tr>';
                } else {
                    table.innerHTML = floorStats.map(stat => `
                        <tr>
                            <td>${stat.rarity}</td>
                            <td>${stat.floor_price} ETH</td>
                            <td>${stat.currency_address === '0x0000000000000000000000000000000000000000' ? 'ETH' : 'ERC20'}</td>
                            <td>${stat.sample_size}</td>
                            <td>${new Date(stat.last_updated).toLocaleString()}</td>
                        </tr>
                    `).join('');
                }
                
                loading.style.display = 'none';
                content.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'Failed to load floor prices: ' + err.message;
            }
        }

        async function loadTrendingTokens() {
            const loading = document.getElementById('topViewedLoading');
            const error = document.getElementById('topViewedError');
            const content = document.getElementById('topViewedContent');
            const table = document.getElementById('topViewedTable');

            loading.style.display = 'block';
            error.style.display = 'none';
            content.style.display = 'none';

            try {
                const trending = await getTrendingTokens(10);
                
                if (trending.length === 0) {
                    table.innerHTML = '<tr><td colspan="3" class="no-data">No trending tokens data available</td></tr>';
                } else {
                    table.innerHTML = trending.map(token => `
                        <tr>
                            <td>#${token.token_id}</td>
                            <td>${token.count}</td>
                            <td>${new Date(token.last_occurrence).toLocaleString()}</td>
                        </tr>
                    `).join('');
                }
                
                loading.style.display = 'none';
                content.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'Failed to load trending tokens: ' + err.message;
            }
        }

        async function loadRecentActivity() {
            const loading = document.getElementById('recentActivityLoading');
            const error = document.getElementById('recentActivityError');
            const content = document.getElementById('recentActivityContent');
            const table = document.getElementById('recentActivityTable');

            loading.style.display = 'block';
            error.style.display = 'none';
            content.style.display = 'none';

            try {
                const { data: activities, error: activityError } = await supabase
                    .from('activity_logs')
                    .select('*')
                    .order('timestamp', { ascending: false })
                    .limit(20);

                if (activityError) throw activityError;
                
                if (activities.length === 0) {
                    table.innerHTML = '<tr><td colspan="4" class="no-data">No recent activity</td></tr>';
                } else {
                    table.innerHTML = activities.map(activity => `
                        <tr>
                            <td>${activity.user_id.substring(0, 8)}...</td>
                            <td><span class="badge ${getBadgeClass(activity.event_type)}">${activity.event_type}</span></td>
                            <td>${activity.token_id || '-'}</td>
                            <td>${new Date(activity.timestamp).toLocaleString()}</td>
                        </tr>
                    `).join('');
                }
                
                loading.style.display = 'none';
                content.style.display = 'block';
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = 'Failed to load recent activity: ' + err.message;
            }
        }

        function getBadgeClass(eventType) {
            switch (eventType) {
                case 'purchase_completed':
                case 'sale_completed':
                    return 'success';
                case 'listing_created':
                    return 'warning';
                case 'listing_cancelled':
                    return 'error';
                default:
                    return 'success';
            }
        }

        function showError(message) {
            const existingError = document.querySelector('.error');
            if (existingError) {
                existingError.textContent = message;
                existingError.style.display = 'block';
            }
        }

        window.refreshData = loadDashboardData;

        // Auto-refresh every 30 seconds
        setInterval(loadDashboardData, 30000);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Handle timeframe changes
        document.getElementById('timeframe').addEventListener('change', loadDashboardData);
    </script>
</body>
</html>